![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/direct/e2addc19617d47e79f46bec0aef6ff72.png#pic_center)

> ShenYuæ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ API ç½‘å…³ã€‚æœ‰å…³ShenYuçš„ä»‹ç»å¯ä»¥[æˆ³è¿™](https://shenyu.apache.org/zh/docs/index/)ã€‚

## ä¸€ã€å‰ç»

ä»Šå¤©æˆ‘ä»¬å°è¯•ä¸åŒçš„ä»£ç é˜…è¯»æ–¹å¼ï¼Œ**æŒ‰æ¨¡å—**æ¥å»é˜…è¯»æºç ï¼Œçœ‹çœ‹æ•ˆæœå¦‚ä½•ã€‚

![å¾®ä¿¡æˆªå›¾_20240321155735](D:\code\z-mine\my_blog\2024.3.21\å¾®ä¿¡æˆªå›¾_20240321161206.png)

æœ¬æ¬¡é˜…è¯»é”å®šåœ¨**shenyu-loadbalancer**ï¼Œæ ¹æ®æ¨¡å—åå¯ä»¥äº†è§£è¿™ä¸ªæ¨¡å—ä¸»è¦ä½œç”¨å°±æ˜¯**è´Ÿè½½å‡è¡¡**ã€‚

æˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ªæ¨¡å—çš„ç»„ç»‡æœºæ„ï¼Œæ¥æ€è€ƒæœ¬æ¬¡çš„**é˜…è¯»çº¿ç´¢**ï¼š

1. æ•´ä¸ªæ¨¡å—ä¸ºShenYuæä¾›äº†ä»€ä¹ˆåŠŸèƒ½
2. æˆ‘ä»¬å¾ˆå¥½å¥‡ï¼Œè´Ÿè½½å‡è¡¡çš„cacheç¼“å­˜æœ‰ä»€ä¹ˆä½œç”¨
3. spiçš„ä½œç”¨æ˜¯ä»€ä¹ˆ

## äºŒã€æ¢ç´¢

é‚£å¼€å§‹æˆ‘ä»¬ä»Šå¤©çš„æ¨¡å—é˜…è¯»ã€‚

çœ‹èµ·æ¥factoryå°±æ˜¯è¿™ä¸ªæ¨¡å—çš„æ ¸å¿ƒäº†ï¼Œä½œä¸º**å·¥å‚**æ¥ç”Ÿäº§æ ¸å¿ƒå¯¹è±¡ï¼Œæˆ‘ä»¬å°±ä»è¿™ä¸ªå·¥å‚å¼€å§‹é˜…è¯»ã€‚

```java
public final class LoadBalancerFactory {

    private LoadBalancerFactory() {
    }

    /**
     * Selector upstream.
     *
     * @param upstreamList the upstream list
     * @param algorithm    the loadBalance algorithm
     * @param ip           the ip
     * @return the upstream
     */
    public static Upstream selector(final List<Upstream> upstreamList, final String algorithm, final String ip) {
        LoadBalancer loadBalance = ExtensionLoader.getExtensionLoader(LoadBalancer.class).getJoin(algorithm);
        return loadBalance.select(upstreamList, ip);
    }
}
```

å¾ˆæ˜æ˜¾LoadBalancerFactoryæ˜¯ä½œä¸ºå¤–éƒ¨çš„è°ƒç”¨ä¸­å¿ƒï¼Œé‚£LoadBalancerFactoryåˆæ˜¯è°ƒç”¨äº†å†…éƒ¨çš„ä»€ä¹ˆæ¨¡å—å»è¿”å›ï¼Ÿæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ã€‚

```java
@SPI
public interface LoadBalancer {

    /**
     * this is select one for upstream list.
     *
     * @param upstreamList upstream list
     * @param ip ip
     * @return upstream
     */
    Upstream select(List<Upstream> upstreamList, String ip);
}
```

å¯ä»¥çœ‹åˆ°é€šè¿‡**selectæ–¹æ³•**è¿›è¡Œè°ƒç”¨å†…éƒ¨æ–¹æ³•ã€‚

æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹è¿™ä¸ªæ¥å£ç±»çš„ç±»å›¾ï¼Œçœ‹ä¸‹è°ƒç”¨çš„æœ€ç»ˆå®ç°è€…æ˜¯ä»€ä¹ˆå¯¹è±¡ã€‚

![å¾®ä¿¡æˆªå›¾_20240321161445](D:\code\z-mine\my_blog\2024.3.21\å¾®ä¿¡æˆªå›¾_20240321161445.png)

ç±»å›¾å¾ˆæ¸…æ™°åœ°å‘Šè¯‰æˆ‘ä»¬ï¼Œæœ€ç»ˆå®ç°è€…å…±æœ‰6ä¸ªå­ç±»å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªå­ç±»å¯¹è±¡éƒ½æ˜¯**ä¸åŒçš„è´Ÿè½½å‡è¡¡ç®—æ³•å®ç°**ã€‚

å¤§å®¶æœ‰æ²¡çœ‹åˆ°ç±»å›¾æœ€ä¸Šé¢çš„åº•å±‚æ¥å£SPIï¼Œå’Œæ¨¡å—é‡Œçš„spiæ–‡ä»¶å¤¹æ˜¯**ç›¸å¯¹åº”çš„**ï¼Œspiçš„ä½œç”¨å°±æ˜¯**å­˜å‚¨å„ç§è´Ÿè½½å‡è¡¡ç®—æ³•çš„å®ç°**ã€‚é‚£æˆ‘ä»¬å°±è§£å†³äº†æˆ‘ä»¬çš„é˜…è¯»çº¿ç´¢3ã€‚

> spiçš„ä½œç”¨æ˜¯ä»€ä¹ˆ

æˆ‘ä»¬ç»§ç»­æ¢ç´¢ï¼Œçœ‹çœ‹é˜…è¯»çº¿ç´¢2çš„ç­”æ¡ˆï¼š

> è´Ÿè½½å‡è¡¡çš„cacheç¼“å­˜æœ‰ä»€ä¹ˆä½œç”¨

![å¾®ä¿¡æˆªå›¾_20240321162801](D:\code\z-mine\my_blog\2024.3.21\å¾®ä¿¡æˆªå›¾_20240321162801.png)

æŸ¥è¯¢ä»£ç å‘ç°ç¼“å­˜å¯¹è±¡æ˜¯UPSTREAM_MAPï¼Œä½†å¾ˆå¥‡æ€ªè¿™ä¸ªæ ¸å¿ƒçš„ç¼“å­˜å¯¹è±¡åªæœ‰åˆ é™¤ã€è®¾ç½®çš„å¼•ç”¨ï¼Œå´æ²¡æœ‰ä½¿ç”¨çš„é€»è¾‘ã€‚

é€šè¿‡**Gitçš„å†å²æŸ¥è¯¢**ï¼Œå‘ç°è¿™ä¸ªç¼“å­˜å¯¹è±¡è¢«åºŸå¼ƒäº†ï¼Œæœ€æ–°ç‰ˆæœ¬çš„æ ¸å¿ƒç¼“å­˜å¯¹è±¡åº”è¯¥æ˜¯ä¸‹é¢è¿™ä¸¤ä¸ª

```java
    private final Map<String, List<Upstream>> healthyUpstream = Maps.newConcurrentMap();

    private final Map<String, List<Upstream>> unhealthyUpstream = Maps.newConcurrentMap();
```

æ‰¾åˆ°äº†æ ¸å¿ƒç¼“å­˜å¯¹è±¡ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™ä¸ªcacheå¯¹è±¡çš„ä½œç”¨ç©¶ç«Ÿæ˜¯ä»€ä¹ˆã€‚

æˆ‘ä»¬çœ‹çœ‹è°ƒç”¨ç¼“å­˜çš„å¯¹åº”æ–¹æ³•ã€‚

![å¾®ä¿¡æˆªå›¾_20240321165408](D:\code\z-mine\my_blog\2024.3.21\å¾®ä¿¡æˆªå›¾_20240321165408.png)

Upstreamæµä»**shenyu-loadbalancer**å–å‡ºï¼Œéœ€è¦è´Ÿè½½å‡è¡¡æ—¶æŠŠè¯¥ç¼“å­˜ä¼ å…¥ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ¨¡å—çš„cacheå……å½“äº†**å­˜å‚¨æ‰€æœ‰Upstreamæµ**çš„ä½œç”¨ã€‚

åˆ°è¿™æˆ‘ä»¬å°±è§£å†³äº†é˜…è¯»çº¿ç´¢2çš„é—®é¢˜äº†ã€‚

## ä¸‰ã€æ€»ç»“

è€Œé˜…è¯»çº¿ç´¢3ä¹Ÿæ˜¾è€Œæ˜“è§ï¼š`æ•´ä¸ªæ¨¡å—ä¸ºShenYuæä¾›äº†ä»€ä¹ˆåŠŸèƒ½`ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹ä¸Šæ–‡æˆ‘ä»¬æåˆ°çš„å·¥å‚å¯¹è±¡ã€‚

```java
public final class LoadBalancerFactory {

    private LoadBalancerFactory() {
    }

    /**
     * Selector upstream.
     *
     * @param upstreamList the upstream list
     * @param algorithm    the loadBalance algorithm
     * @param ip           the ip
     * @return the upstream
     */
    public static Upstream selector(final List<Upstream> upstreamList, final String algorithm, final String ip) {
        LoadBalancer loadBalance = ExtensionLoader.getExtensionLoader(LoadBalancer.class).getJoin(algorithm);
        return loadBalance.select(upstreamList, ip);
    }
}
```

æ ¸å¿ƒæ–¹æ³•å¾ˆæ¸…æ™°ï¼Œæˆ‘ä»¬ä¼ å…¥Upsteamåˆ—è¡¨ï¼Œé€šè¿‡è¿™ä¸ªæ¨¡å—çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œ**è´Ÿè½½å‡è¡¡åœ°è¿”å›**å…¶ä¸­ä¸€ä¸ªå¯¹è±¡ã€‚

è¿™ä¹Ÿå°±æ˜¯è¿™ä¸ªæ¨¡å—æä¾›çš„åŠŸèƒ½ã€‚



## æœªå®Œå¾…ç»­ã€‚ã€‚ã€‚

å¥½äº†ï¼Œä»Šå¤©çš„åˆ†äº«å°±åˆ°è¿™ğŸ¤”ã€‚**å¤§å®¶èƒ½å¦æ„Ÿå—åˆ°é€šè¿‡æŒ‰æ¨¡å—è¿™ç§æ–¹å¼æ¥é˜…è¯»æºç çš„ä¹è¶£å‘¢** ï¼

> **åˆ›ä½œä¸æ˜“ï¼Œä¸å¦¨ç‚¹èµã€æ”¶è—ã€å…³æ³¨æ”¯æŒä¸€ä¸‹ï¼Œå„ä½çš„æ”¯æŒå°±æ˜¯æˆ‘åˆ›ä½œçš„æœ€å¤§åŠ¨åŠ›**â¤ï¸