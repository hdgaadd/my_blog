> ç›¸ä¿¡å¤§å®¶ç¢°åˆ°æºç æ—¶ç»å¸¸æ— ä»ä¸‹æ‰‹ğŸ™ƒï¼Œä¸çŸ¥é“ä»å“ªå¼€å§‹é˜…è¯»ï¼Œé¢å¯¹å¤§é‡ä»£ç æ™•å¤´è½¬å‘ï¼Œç´¢æ€§å°±è¯»ä¸ä¸‹å»äº†ï¼Œåˆæµªè´¹äº†ä¸€æ¬¡æå‡è‡ªå·±çš„æœºä¼šğŸ˜­ã€‚
>
> <br/>
>
> æˆ‘è®¤ä¸º**æœ‰ä¸€ç§æ–¹æ³•**ï¼Œå¯ä»¥è§£å†³å¤§å®¶çš„å›°æ‰°ï¼**é‚£å°±æ˜¯é€šè¿‡é˜…è¯»æŸä¸€æ¬¡å¼€æºçš„ã€PRã€‘ã€ã€ISSUEã€‘ï¼Œä»è¿™ä¸ªå…¥å£å‡ºå‘å»é˜…è¯»æºç ï¼ï¼**
>
> <br/>
>
> è‡³æ­¤ï¼Œæˆ‘ä»¬å‘ç°è‡ªå·±å¼€å§‹ä»å¤§é‡å †ç Œçš„æºç ä¸­è„±ç¦»å¼€æ¥ğŸ˜€ã€‚è±ç„¶å¼€æœ—ï¼ŒæŸ³æš—èŠ±æ˜åˆä¸€æ‘ã€‚


ShenYuæ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ API ç½‘å…³ã€‚æœ‰å…³ShenYuçš„ä»‹ç»å¯ä»¥[æˆ³è¿™](https://shenyu.apache.org/zh/docs/index/)ã€‚

## ä¸€ã€å‰ç»

å¥½äº†ï¼Œä»Šå¤©æˆ‘ä»¬æ¥çœ‹çœ‹æœ¬æ¬¡çš„[PRæäº¤](https://github.com/apache/shenyu/pull/5060)

![å¾®ä¿¡æˆªå›¾_20240227104837](D:\code\z-mine\my_blog\2024.2.27\å¾®ä¿¡æˆªå›¾_20240227104837.png)

æˆ‘ä»¬çœ‹ä¸‹PRçš„æ ‡é¢˜å’ŒConcersationçš„å¤´ä¸€å¥ï¼Œå¤§æ¦‚æ„æ€å°±æ˜¯**é‡æ„æ³¨å†Œä¸­å¿ƒæ•°æ®åŒæ­¥åˆ°ShenYuç½‘å…³çš„æ–¹å¼**ã€‚

é˜…è¯»æºç å‰ï¼Œæˆ‘ä»¬å…ˆæ€è€ƒæˆ‘ä»¬æœ¬æ¬¡è¦é˜…è¯»çš„çº¿ç´¢ï¼š

1. è´¡çŒ®è€…æ˜¯æ€ä¹ˆé‡æ„çš„
2. é‡æ„äº†ç›¸å¯¹äºåŸå…ˆæ—§æ–¹å¼æœ‰ä»€ä¹ˆ**å¥½å¤„**

## äºŒã€æ¢ç´¢

æœ¬æ¬¡PRä»£ç é‡è¿˜æ˜¯å¾ˆ**å·¨å¤§**äº†ï¼Œä»[PRæäº¤](https://github.com/apache/shenyu/pull/5060)å¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰**82æ¬¡æäº¤ï¼ï¼ï¼**ä¸è¦æ€•ï¼Œæˆ‘ä»¬å…ˆæ•´ä½“æµè§ˆä¸‹æ•´ä¸ªæäº¤ï¼Œåœ¨é«˜çš„ç»´åº¦å»çœ‹è´¡çŒ®è€…å…·ä½“åšäº†ä»€ä¹ˆåŠ¨ä½œã€‚

![å¾®ä¿¡æˆªå›¾_20240227111146](D:\code\z-mine\my_blog\2024.2.27\å¾®ä¿¡æˆªå›¾_20240227111146.png)

æ€»çš„æ¥è¯´å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œ**é‡æ„æä¾›åŒæ­¥æ•°æ®çš„å®¢æˆ·ç«¯ã€é‡æ„ä½¿ç”¨åŒæ­¥æ•°æ®çš„Adminè°ƒç”¨ç«¯**ï¼ˆå‡†ç¡®æ¥è¯´æ˜¯ç›‘å¬ç«¯ï¼Œä¸‹æ–‡éƒ½ä¹¦å†™ä¸ºè°ƒç”¨ç«¯æ›´å®¹æ˜“ç†è§£ï¼‰ã€‚

æˆ‘ä»¬å…ˆçœ‹çœ‹Nacosçš„é‡æ„æ­¥éª¤ï¼Œå…¶ä»–æ³¨å†Œä¸­å¿ƒé‡æ„é€»è¾‘å¤§è‡´ä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚

```java
public class NacosSyncDataService extends AbstractNodeDataSyncService implements SyncDataService {
}
```

NacosåŒæ­¥æ•°æ®çš„`NacosSyncDataService`ç»§æ‰¿äº†`AbstractNodeDataSyncService`ï¼Œæˆ‘ä»¬åº”è¯¥é‡ç‚¹é˜…è¯»çˆ¶ç±»çº¦å®šçš„è§„åˆ™å’Œæä¾›çš„å®ç°ã€‚

![å¾®ä¿¡æˆªå›¾_20240227113338](D:\code\z-mine\my_blog\2024.2.27\å¾®ä¿¡æˆªå›¾_20240227113338.png)

ä¸Šå›¾å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªæŠ½è±¡ç±»**AbstractNodeDataSyncServiceã€AbstractPathDataSyncService**ï¼ŒNodeDataã€PataDataé¡¾åæ€ä¹‰å‰è€…æ˜¯å¤„ç†Nacosè¿™ç±»èŠ‚ç‚¹ç±»å‹çš„æ³¨å†Œä¸­å¿ƒï¼Œåè€…å°±æ˜¯å¤„ç†ZooKeeperè¿™ç±»çš„è·¯å¾„èŠ‚ç‚¹æ³¨å†Œä¸­å¿ƒã€‚

å¤§å®¶æ€è€ƒä¸‹ï¼Œæœ¬æ¬¡PRæäº¤ä¸€ç›´æåˆ°**åŒæ­¥æ•°æ®**ï¼Œé‚£ç©¶ç«Ÿé ä»€ä¹ˆæ¥åŒæ­¥æ•°æ®ï¼Ÿå…¶å®Nacosæœ‰**é…ç½®ä¸­å¿ƒ**çš„åŠŸèƒ½ï¼ŒåŒæ­¥æ•°æ®ä¹Ÿå°±æ˜¯åŒæ­¥Nacosé…ç½®ä¸­å¿ƒçš„æ•°æ®ï¼Œæ–¹ä¾¿ShenYuä¿®æ”¹æ•°æ®å°±ç«‹åˆ»ç”Ÿæ•ˆ**è€Œä¸ç”¨é‡å¯**ã€‚

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`AbstractNodeDataSyncService`çš„**startWatch**æ–¹æ³•ï¼Œå„ä¸ªwatchæ–¹æ³•æ¥ç›‘å¬é…ç½®ä¸­å¿ƒçš„æ•°æ®ã€‚

```java
    protected void startWatch() {
        try {
            final List<String> pluginNames = getConfigListOnWatch(changeData.getPluginDataId() + DefaultNodeConstants.POINT_LIST, updateData -> {
                List<String> changedPluginNames = GsonUtils.getInstance().fromList(updateData, String.class);
                watcherPlugin(changedPluginNames);
            });

            watcherPlugin(pluginNames);

            watchCommonList(changeData.getAuthDataId() + DefaultNodeConstants.JOIN_POINT, this::cacheAuthData, this::unCacheAuthData);

            watchCommonList(changeData.getMetaDataId() + DefaultNodeConstants.JOIN_POINT, this::cacheMetaData, this::unCacheMetaData);

        } catch (Exception e) {
            throw new ShenyuException(e);
        }
    }
```

å…¶ä¸­`getServiceConfig`å°±æ˜¯ç•™ç»™å„ä¸ªå­ç±»æ¥å®ç°çš„åŠŸèƒ½ï¼Œä¸åŒçš„é…ç½®ä¸­å¿ƒï¼Œä¸åŒè·å–é…ç½®çš„æ–¹æ³•ã€‚

```java
protected abstract String getServiceConfig(String key, Consumer<String> updateHandler, Consumer<String> deleteHandler);
```

æˆ‘ä»¬æ¥çœ‹çœ‹è·å–Nacosé…ç½®çš„å­ç±»NacosSyncDataServiceæ˜¯æ€ä¹ˆè·å–çš„ã€‚

```java
public class NacosSyncDataService extends AbstractNodeDataSyncService implements SyncDataService {
    
    private final ConfigService configService;

    @Override
    protected String getServiceConfig(final String key, final Consumer<String> updateHandler, final Consumer<String> deleteHandler) {
        try {
            if (watchCache.containsKey(key)) {
                return null;
            }
            final Listener listener = new Listener() {
                @Override
                public Executor getExecutor() {
                    return null;
                }

                @Override
                public void receiveConfigInfo(final String configInfo) {
                    try {
                        if (StringUtils.isBlank(configInfo) && deleteHandler != null) {
                            deleteHandler.accept(key);
                        } else {
                            updateHandler.accept(configInfo);
                        }
                    } catch (Exception e) {
                        LOG.error("nacos sync listener receiveConfigInfo error", e);
                    }
                }
            };
            final String serviceConfig = configService.getConfigAndSignListener(key, NacosPathConstants.GROUP, 3000, listener);
            watchCache.put(key, listener);
            return serviceConfig;
        } catch (Exception e) {
            throw new ShenyuException(e);
        }
    }
}
```

å¯ä»¥çœ‹åˆ°è¯¥ç±»é€šè¿‡è°ƒç”¨Nacosæä¾›çš„ConfigServiceæœåŠ¡æ¥è¿›è¡Œè·å–é…ç½®ï¼ŒåŒæ—¶Listenerå°±æ˜¯ç›‘å¬å™¨çš„ä½œç”¨ã€‚

å¤§è‡´çœ‹å®Œäº†**å®¢æˆ·ç«¯çš„é‡æ„**ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹**ShenYu Adminè°ƒç”¨ç«¯çš„é‡æ„**ã€‚æ—¢ç„¶å®¢æˆ·ç«¯æ˜¯åŒæ­¥é…ç½®ä¸­å¿ƒçš„æ•°æ®ï¼Œé‚£è°ƒç”¨ç«¯ä¹Ÿå°±æ˜¯èµ·åˆ°**åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤é…ç½®çš„ä½œç”¨**ã€‚

![å¾®ä¿¡æˆªå›¾_20240227140225](D:\code\z-mine\my_blog\2024.2.27\å¾®ä¿¡æˆªå›¾_20240227140225.png)

å›é¡¾ä¸‹ä¸Šæ–‡æåˆ°çš„**AbstractNodeDataSyncServiceã€AbstractPathDataSyncService**ï¼Œä¸Šå›¾çš„**AbstractNodeDataChangeListenerã€AbstractPathDataChangeListener**åŒæ ·æ˜¯å®ç°æŸäº›å…·ä½“çš„åŠŸèƒ½ï¼Œéœ€è¦å­ç±»å®ç°çš„å»¶è¿Ÿåˆ°å­ç±»å®ç°ã€‚

æˆ‘ä»¬çœ‹ä¸‹**å­ç±»NacosDataChangedListener**å®ç°çš„åŠŸèƒ½ã€‚

```java
public class NacosDataChangedListener extends AbstractNodeDataChangedListener {

    private static final Logger LOG = LoggerFactory.getLogger(NacosDataChangedListener.class);

    private final ConfigService configService;

    public NacosDataChangedListener(final ConfigService configService) {
        super(new ChangeData(NacosPathConstants.PLUGIN_DATA_ID, NacosPathConstants.SELECTOR_DATA_ID,
                NacosPathConstants.RULE_DATA_ID, NacosPathConstants.AUTH_DATA_ID, NacosPathConstants.META_DATA_ID,
                NacosPathConstants.PROXY_SELECTOR_DATA_ID, NacosPathConstants.DISCOVERY_DATA_ID));
        this.configService = configService;
    }

    @Override
    public void doPublishConfig(final String dataId, final Object data) {
        try {
            configService.publishConfig(
                    dataId, 
                    NacosPathConstants.GROUP, 
                    GsonUtils.getInstance().toJson(data),
                    ConfigType.JSON.getType());
        } catch (NacosException e) {
            LOG.error("Publish data to nacos error.", e);
            throw new ShenyuException(e.getMessage());
        }
    }

    @Override
    public void doDelConfig(final String dataId) {
        try {
            configService.removeConfig(
                    dataId,
                    NacosPathConstants.GROUP);
        } catch (NacosException e) {
            LOG.error("Publish data to nacos error.", e);
            throw new ShenyuException(e.getMessage());
        }
    }

    @Override
    public String getConfig(final String dataId) {
        try {
            return configService.getConfig(dataId, NacosPathConstants.GROUP, NacosPathConstants.DEFAULT_TIME_OUT);
        } catch (NacosException e) {
            LOG.error("Get data from nacos error.", e);
            throw new ShenyuException(e.getMessage());
        }
    }

}
```

æ­£å¦‚ä¸Šæ–‡æˆ‘ä»¬æ‰€è¯´çš„ï¼š

> æ—¢ç„¶å®¢æˆ·ç«¯æ˜¯åŒæ­¥é…ç½®ä¸­å¿ƒçš„æ•°æ®ï¼Œé‚£è°ƒç”¨ç«¯ä¹Ÿå°±æ˜¯èµ·åˆ°**åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤é…ç½®çš„ä½œç”¨**ã€‚



## ä¸‰ã€æ‹“å±•

ä¸ä¼šå§ï¼Œå¤§å®¶è¿˜è®°å¾—æˆ‘ä»¬çš„é˜…è¯»çº¿ç´¢2å—ï¼Œé‡æ„äº†ç›¸å¯¹äºåŸå…ˆæ—§æ–¹å¼æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

æˆ‘ä»¬ä»”ç»†çœ‹ä¸‹ä¸Šæ–‡æåˆ°çš„AbstractNodeDataSyncServiceã€AbstractPathDataSyncServiceç­‰è¿™å‡ ä¸ªæŠ½è±¡ç±»å°±çŸ¥é“äº†ï¼ŒæŠ½è±¡çˆ¶ç±»æŠŠ**é‡å¤çš„åŠŸèƒ½**å®ç°ï¼Œè€Œ**è·å–é…ç½®**è¿™ç§å„ä¸ªé…ç½®ä¸­å¿ƒæœ‰ä¸åŒçš„è·å–æ–¹å¼ï¼Œå°±ç•™ç»™äº†å„ä¸ªé…ç½®ä¸­å¿ƒçš„**å­ç±»å®ç°**ã€‚

è€ŒåŸå…ˆçš„æ—§ä»£ç ï¼Œæ¯ä¸ªä¸åŒçš„é…ç½®ä¸­å¿ƒéƒ½è¦å®ç°ä¸€å¥—**é‡å¤çš„æ–¹æ³•ä»£ç **ï¼Œä»£ç è€¦åˆä¸”ä¸æ˜“æ‰©å±•ã€‚å¤§å®¶çœ‹çœ‹é‡æ„äº†æœ‰æ²¡å¥½å¤„å‘¢ã€‚

![å¾®ä¿¡æˆªå›¾_20240227142256](D:\code\z-mine\my_blog\2024.2.27\å¾®ä¿¡æˆªå›¾_20240227142256.png)

å’¦ï¼Ÿä»”ç»†çœ‹äº†ä¸‹ï¼Œè´¡çŒ®è€…çš„ç±»æ³¨é‡Šå†™é”™äº†å•Šã€‚

![å¾®ä¿¡æˆªå›¾_20240227142605](D:\code\z-mine\my_blog\2024.2.27\å¾®ä¿¡æˆªå›¾_20240227142605.png)

å¼€å¿ƒåˆè·å¾—äº†ä¸€æ¬¡å¼€æºè´¡çŒ®ï¼æƒ³çœ‹ä¸‹å¼€æºPR[æˆ³è¿™](https://github.com/apache/shenyu/pull/5456)

![å¾®ä¿¡æˆªå›¾_20240227144349](D:\code\z-mine\my_blog\2024.2.27\å¾®ä¿¡æˆªå›¾_20240227144349.png)

å¥½äº†ï¼Œä»Šå¤©çš„åˆ†äº«å°±åˆ°è¿™äº†ã€‚**å¤§å®¶èƒ½å¦æ„Ÿå—åˆ°é€šè¿‡PRè¿™ç§æ–¹å¼æ¥é˜…è¯»æºç çš„ä¹è¶£å‘¢ï¼ä¸ä»…è·å¾—äº†çŸ¥è¯†ï¼Œè¿˜è·å¾—äº†ä¸€æ¬¡å¼€æºè´¡çŒ®ï¼Œä½•ä¹è€Œä¸ä¸ºå‘¢** 

> åšä¸»çš„GitHubä¹Ÿæœ‰ä¸€äº›è¯»è€…æ„Ÿå…´è¶£çš„çŸ¥è¯†å¯ä»¥å­¦ä¹ ğŸ˜ï¼Œ[GitHubåœ°å€æˆ³è¿™](https://github.com/hdgaadd)
>
> <br/>
>
> **åˆ›ä½œä¸æ˜“ï¼Œä¸å¦¨ç‚¹èµã€æ”¶è—ã€å…³æ³¨æ”¯æŒä¸€ä¸‹ï¼Œå„ä½çš„æ”¯æŒå°±æ˜¯æˆ‘åˆ›ä½œçš„æœ€å¤§åŠ¨åŠ›**â¤ï¸