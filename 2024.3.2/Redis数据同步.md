> 面试官：咳咳咳，看你简历写了精通Redis，那我就随便考考你吧
>
> <br/>
>
> 面试官：不用慌尽管说，错了也没关系。。。

## 面试官：我看你们项目用的Redis集群，数据同步了解吗

好的面试官。数据同步主要是利用了**RDB文件**来进行数据同步。

1. 首先，从服务器会先向主服务器发送**SYNC命令**
2. 收到命令后，主服务器会执行**BGSAVE命令**来生成一个**RDB文件**，并使用**AOF缓冲区**来记录在生成期间执行的写命令
3. 完成第二步后，主服务器会将RDB文件发送给从服务器，让从服务器同步RDB文件数据
4. 当然这还没完，主服务器的AOF缓冲区还会发送给从服务器，让它们之间的数据同步至**最终状态**
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/d95d0c931332495796c533bfebb56a90.png#pic_center)


> <br/>
>
> 面试官歪了歪脑袋，想了想…
>
> <br/>

## 面试官：按你这么说，数据同步后主服务器某个键删除了，数据又不同步了怎么办

噢噢好的。是这样的，Redis有一个叫**命令传播**的概念。

如果像面试官说的这种场景，再使用上面我提到的AOF缓冲区就有点浪费内存空间了。所以Redis会将主服务器的这条Del删除命令，**发送给从服务器**。

当从服务执行命令后，数据也就同步了。

> <br/>
>
> 面试官想：还知道命令传播，继续深入考你…
>
> <br/>

## 面试官：如果主从服务器断线呢？还是用的RDB来同步吗

不是的面试官。用的RDB来数据同步太**消耗资源**了，比如像CPU、内存、磁盘IO消耗。

如果是**短时间断线**，根本没有必要使用这么浪费资源的笨方法…

Redis它其实有一个叫**PSYNC命令**，主从服务器断线后，从服务器会发送一个PSYNC命令给主服务器。收到命令后主服务器会发送给从服务器**断线期间执行的写命令**。

这样从服务器执行命令后，它们的数据也就同步了。这种同步方式也叫**部分重同步**。

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/3f710638b6bb4bac91fc04b73a573737.png#pic_center)

> <br/>
>
> 面试官思考中…
>
> <br/>

## 面试官：考你点深入些的，主服务器怎么知道断线期间执行了哪些命令呢

emmmmm我想想。

其实每个Redis节点都有维护一个**复制偏移量**，例如主从服务器的初始偏移量都是0，主服务器发送给从服务器**N字节数据**，主从服务器的偏移量就会+N。

通过这种形式来记录同步状态。

另外主服务器不是会进行**命令传播**吗，同时它还会把命令传播的命令保存在一个有**复制偏移量**标识的**复制积压缓冲区**队列。

所以从服务器发送PSYNC命令同时发送复制偏移量，主服务器只要根据复制偏移量在队列中找到对应的命令就可以了。

> <br/>
>
> 面试官想：可以的小伙子
>
> <br/>

## 面试官：你知道服务器运行ID吗

哦哦知道的，每个Redis节点都有自己的服务器运行ID。

当从服务器对主服务器进行**初次复制**时，主服务器会将自己的**运行ID**传送给从服务器，而从服务器则会将这个运行ID保存起来。

当**断线后数据同步时**，从服务器将向当前连接的主服务器发送**之前保存的运行ID**。

如果此时主服务器发现从服务器发送的**运行ID**，和自己的不一致。说明此时的主服务器是**新的**主服务器，它也没有**复制积压缓冲区**队列，也就不能进行**部分重同步**。

所以此时主服务器会向从服务器发送RDB文件来进行数据同步，服务器运行ID**主要是这个作用**。

> <br/>
>
> 面试官有点慌了不知道还能问啥…    
>
> <br/>

## 面试官：Redis心跳检测知道吧

知道的，面试官。

从服务器默认会**每秒一次**向主服务器发送命令，如果主服务器超过1s没有收到replconf命令，说明主从服务器的网络连接有问题了。

```js
REPLCONF ACK ＜replication_offset＞
```

同时这个心跳检测命令还会附带传送一个**复制偏移量**，也就是`replication_offset`。

如果心跳检测时，主服务器发现他们的复制偏移量不一致，就会通过该偏移量找到从服务器**丢失的写命令**，发送给从服务器保持同步。

心跳检测也有**检测命令丢失**的功能。

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/a7533a53b2ad4d6eaf886a50f28d7a41.png#pic_center)

> 面试官抓抓脑袋，继续看你的简历......
> 
> <br/>
> 
> 得想想考点你不懂的

## 未完待续。。。。。。

好了，今天的分享就先到这，我们下期继续。

> 博主GitHub也有一些读者感兴趣的💪，[GitHub戳这](https://github.com/hdgaadd)，你的 ⭐️ Star ⭐️，是作者的动力！
>
> <br/>
>
> 博客首发：[CSDN](https://blog.csdn.net/hdgaadd)、[掘金](https://juejin.cn/user/853686632850381/posts)
>
> <br/>
>
> **创作不易，不妨点赞、收藏、关注支持一下，各位的支持就是我创作的最大动力**❤️













































