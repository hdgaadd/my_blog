> ç›¸ä¿¡å¤§å®¶ç¢°åˆ°æºç æ—¶ç»å¸¸æ— ä»ä¸‹æ‰‹ğŸ™ƒï¼Œä¸çŸ¥é“ä»å“ªå¼€å§‹é˜…è¯»ï¼Œé¢å¯¹å¤§é‡ä»£ç æ™•å¤´è½¬å‘ï¼Œç´¢æ€§å°±è¯»ä¸ä¸‹å»äº†ï¼Œåˆæµªè´¹äº†ä¸€æ¬¡æå‡è‡ªå·±çš„æœºä¼šğŸ˜­ã€‚
>
> <br/>
>
> æˆ‘è®¤ä¸º**æœ‰ä¸€ç§æ–¹æ³•**ï¼Œå¯ä»¥è§£å†³å¤§å®¶çš„å›°æ‰°ï¼**é‚£å°±æ˜¯é€šè¿‡é˜…è¯»æŸä¸€æ¬¡å¼€æºçš„ã€PRã€‘ã€ã€ISSUEã€‘ï¼Œä»è¿™ä¸ªå…¥å£å‡ºå‘å»é˜…è¯»æºç ï¼ï¼**
>
> <br/>
>
> è‡³æ­¤ï¼Œæˆ‘ä»¬å‘ç°è‡ªå·±å¼€å§‹ä»å¤§é‡å †ç Œçš„æºç ä¸­è„±ç¦»å¼€æ¥ğŸ˜€ï¼Œè±ç„¶å¼€æœ—ï¼ŒæŸ³æš—èŠ±æ˜åˆä¸€æ‘ã€‚





## ä¸€ã€å‰ç»

Okï¼Œå¼€å§‹æˆ‘ä»¬ä»Šå¤©çš„[PRé˜…è¯»](https://github.com/spring-projects/spring-framework/issues/23501)ã€‚

![Snipaste_2024-03-10_13-01-35](E:\z-relax\my_blog\2024.3.10\Snipaste_2024-03-10_13-01-35.png)

æˆ‘ä»¬çœ‹ä¸‹PRçš„æ ‡é¢˜ï¼Œç¿»è¯‘è¿‡æ¥æ˜¯åœ¨å•ä¾‹åˆ›å»ºæœŸé—´**è¿›è¡ŒåŒæ­¥å¯èƒ½ä¼šå¯¼è‡´æ­»é”**ã€‚

é€šè¿‡è¿™ä¸ªæ ‡é¢˜æˆ‘ä»¬å°±å¯ä»¥æ€è€ƒæœ¬æ¬¡çš„**é˜…è¯»çº¿ç´¢**äº†ï¼Œçœ‹èµ·æ¥å¯ä»¥å­¦åˆ°ä¸å°‘ä¸œè¥¿ï¼š

1. æ—§ä»£ç çš„æ­»é”æ˜¯æ€ä¹ˆäº§ç”Ÿçš„
2. è´¡çŒ®è€…é€šè¿‡æ”¹å˜ä»€ä¹ˆæ¥è§£å†³æœ¬æ¬¡PRçš„é—®é¢˜å‘¢



## äºŒã€æ¢ç´¢

Okï¼Œæˆ‘ä»¬æ¥æ•´ä½“çœ‹ä¸‹PRçš„æ‰€æœ‰æäº¤ã€‚

![Snipaste_2024-03-10_13-20-54](E:\z-relax\my_blog\2024.3.10\Snipaste_2024-03-10_13-20-54.png)

ä»£ç æ¶‰åŠä¿®æ”¹äº†Beanåˆ›å»ºå·¥å‚ã€Spring IOCå®¹å™¨çš„ä¸Šä¸‹æ–‡ï¼ŒçŒœæµ‹æ˜¯åœ¨beanåˆ›å»ºè¿‡ç¨‹è¿›è¡Œä¿®å¤ã€‚

è€Œä¸”å¤§å®¶æ³¨æ„ä¸‹æäº¤ä¸‹é¢è¿™è¡Œ**æäº¤æ³¨é‡Š**ï¼Œ`Introduce background bootstrapping for individual singleton beansä¸ºå•ä¸ªå•ä¾‹å¼•å…¥åå°å¼•å¯¼`ã€‚

![Snipaste_2024-03-10_13-23-19](E:\z-relax\my_blog\2024.3.10\Snipaste_2024-03-10_13-23-19.png)

çœ‹ä¸‹åœ¨ConfigurableBeanFactoryç±»ä¸­ç¡®å®**å¼•å…¥äº†ä¸€ä¸ªçº¿ç¨‹**ï¼Œé‚£æˆ‘ä»¬å°±æ¥çœ‹çœ‹å¼•å…¥çš„è¿™ä¸ªçº¿ç¨‹å…·ä½“åšäº†ä»€ä¹ˆå·¥ä½œã€‚

```java
	@Nullable
	private CompletableFuture<?> preInstantiateSingleton(String beanName, RootBeanDefinition mbd) {
		if (mbd.isBackgroundInit()) {
			Executor executor = getBootstrapExecutor(); // è·å–Executor
			if (executor != null) {
				String[] dependsOn = mbd.getDependsOn();
				if (dependsOn != null) {
					for (String dep : dependsOn) {
						getBean(dep);
					}
				}
				CompletableFuture<?> future = CompletableFuture.runAsync(
						() -> instantiateSingletonInBackgroundThread(beanName), executor);
				addSingletonFactory(beanName, () -> {
					try {
						future.join();
					}
					catch (CompletionException ex) {
						ReflectionUtils.rethrowRuntimeException(ex.getCause());
					}
					return future;  // not to be exposed, just to lead to ClassCastException in case of mismatch
				});
				return (!mbd.isLazyInit() ? future : null);
			}
			else if (logger.isInfoEnabled()) {
				logger.info("Bean '" + beanName + "' marked for background initialization " +
						"without bootstrap executor configured - falling back to mainline initialization");
			}
		}
		if (!mbd.isLazyInit()) {
			instantiateSingleton(beanName);
		}
		return null;
	}

```

å¯ä»¥çœ‹åˆ°è¿™æ®µæ ¸å¿ƒä»£ç é€šè¿‡getBootstrapExecutor**è·å–è¯¥çº¿ç¨‹å**ï¼Œå†é€šè¿‡è¯¥Executorçº¿ç¨‹å»æ‰§è¡Œäº†`instantiateSingletonInBackgroundThread`æ–¹æ³•ã€‚

```Java
	private void instantiateSingletonInBackgroundThread(String beanName) {
		this.preInstantiationThread.set(PreInstantiation.BACKGROUND);
		try {
			instantiateSingleton(beanName);
		}
		catch (RuntimeException | Error ex) {
			if (logger.isWarnEnabled()) {
				logger.warn("Failed to instantiate singleton bean '" + beanName + "' in background thread", ex);
			}
			throw ex;
		}
		finally {
			this.preInstantiationThread.set(null);
		}
	}

	private void instantiateSingleton(String beanName) {
		if (isFactoryBean(beanName)) {
			Object bean = getBean(FACTORY_BEAN_PREFIX + beanName);
			if (bean instanceof SmartFactoryBean<?> smartFactoryBean && smartFactoryBean.isEagerInit()) {
				getBean(beanName);
			}
		}
		else {
			getBean(beanName);
		}
	}

```

`instantiateSingletonInBackgroundThread`æ–¹æ³•çš„ä½œç”¨ä¹Ÿå°±æ˜¯åœ¨**é€šè¿‡è¯¥Executorçº¿ç¨‹åœ¨åå°åˆå§‹åŒ–è¯¥Bean**ï¼Œä¹Ÿå°±æ˜¯è¯´åˆå§‹åŒ–Bean**ä¸ä½¿ç”¨ä¸»çº¿ç¨‹**æ¥åˆ›å»ºè€Œæ˜¯é€šè¿‡åˆ›å»ºå¦ä¸€ä¸ª**åå°çº¿ç¨‹**æ¥å»åˆå§‹åŒ–Beanï¼Œä¹Ÿå¯¹åº”äº†æœ¬æ¬¡PRçš„æäº¤æ³¨é‡Šï¼š

> `Introduce background bootstrapping for individual singleton beansä¸ºå•ä¸ªå•ä¾‹å¼•å…¥åå°å¼•å¯¼`

é‚£ä¸ºä»€ä¹ˆè¦**åˆ›å»ºåå°çº¿ç¨‹æ¥åˆå§‹åŒ–Beanï¼Œè€Œä¸ä½¿ç”¨ä¸»çº¿ç¨‹**å‘¢ï¼Ÿ

æˆ‘ä»¬ç¿»é˜…ä¸‹[PRæäº¤](https://github.com/spring-projects/spring-framework/issues/23501)çš„è®¨è®ºã€‚

![Snipaste_2024-03-10_14-05-00](E:\z-relax\my_blog\2024.3.10\Snipaste_2024-03-10_14-05-00.png)

å¤§è‡´æ„æ€å°±æ˜¯Micrometerå¯¹è±¡ä¼šçªƒå¬GCé€šçŸ¥ï¼Œæ‰€ä»¥å®ƒä¼š**ç­‰å¾…å•ä¾‹åˆ›å»ºé”**ï¼Œè€Œ**ä¸»çº¿ç¨‹æ‹¥æœ‰å•ä¾‹åˆ›å»ºé”**ã€‚

å¦‚æœæˆ‘ä»¬ä½¿ç”¨**ä¸»çº¿ç¨‹å»åˆ›å»º**Micrometerå•ä¾‹çš„è¯ï¼ŒMicrometerçš„åˆ›å»ºå®Œæˆéœ€è¦**ä¸»çº¿ç¨‹é‡Šæ”¾é”**ï¼Œè€Œä¸»çº¿ç¨‹é‡Šæ”¾é”åˆ**éœ€è¦Micrometerå…ˆå®Œæˆåˆ›å»º**ã€‚è¿™å°±æ— é™å¾ªç¯äº†ï¼Œæœ€ç»ˆå¯¼è‡´äº†**æ­»é”**ã€‚

åˆ°è¿™é‡Œå°±è§£å†³æˆ‘ä»¬çš„**é˜…è¯»çº¿ç´¢1**äº†ï¼Œå¤§å®¶è¿˜è®°å¾—ä¸ï¼Ÿ

> é˜…è¯»çº¿ç´¢1ï¼šæ—§ä»£ç çš„æ­»é”æ˜¯æ€ä¹ˆäº§ç”Ÿçš„

è€Œ**é˜…è¯»çº¿ç´¢2**çš„ç­”æ¡ˆä¹Ÿæ˜¾è€Œæ˜“è§ï¼Œå°±æ˜¯ä¸Šæ–‡æåˆ°çš„é€šè¿‡**åå°çº¿ç¨‹**æ¥åˆ›å»ºMicrometerå•ä¾‹ã€‚

> é˜…è¯»çº¿ç´¢2ï¼šè´¡çŒ®è€…é€šè¿‡æ”¹å˜ä»€ä¹ˆæ¥è§£å†³æœ¬æ¬¡PRçš„é—®é¢˜å‘¢

ä¸»çº¿ç¨‹é€šè¿‡**åå°çº¿ç¨‹**åˆ›å»ºMicrometerå•ä¾‹ï¼Œå› ä¸ºæ˜¯**å¼‚æ­¥æ‰§è¡Œ**ä¸éœ€è¦ç­‰å¾…åˆ›å»ºå®Œæˆå°±å¯ä»¥é‡Šæ”¾é”ï¼Œè€Œ**åå°çº¿ç¨‹**ç­‰å¾…åˆ°ä¸»çº¿ç¨‹çš„å•ä¾‹é”åå°±å¯ä»¥ç»§ç»­æ‰§è¡Œæµç¨‹ï¼Œé¿å…äº†æ­»é”çš„å‘ç”Ÿã€‚



## æœªå®Œå¾…ç»­ã€‚ã€‚ã€‚

å¥½äº†ï¼Œä»Šå¤©çš„åˆ†äº«å°±åˆ°è¿™äº†ã€‚**å¤§å®¶èƒ½å¦æ„Ÿå—åˆ°é€šè¿‡PRè¿™ç§æ–¹å¼æ¥é˜…è¯»æºç çš„ä¹è¶£å‘¢** ï¼

> **åˆ›ä½œä¸æ˜“ï¼Œä¸å¦¨ç‚¹èµã€æ”¶è—ã€å…³æ³¨æ”¯æŒä¸€ä¸‹ï¼Œå„ä½çš„æ”¯æŒå°±æ˜¯æˆ‘åˆ›ä½œçš„æœ€å¤§åŠ¨åŠ›**â¤ï¸