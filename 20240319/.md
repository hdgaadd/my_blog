![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/direct/e2addc19617d47e79f46bec0aef6ff72.png#pic_center)

> ç›¸ä¿¡å¤§å®¶ç¢°åˆ°æºç æ—¶ç»å¸¸æ— ä»ä¸‹æ‰‹ğŸ™ƒï¼Œä¸çŸ¥é“ä»å“ªå¼€å§‹é˜…è¯»ï¼Œé¢å¯¹å¤§é‡ä»£ç æ™•å¤´è½¬å‘ï¼Œç´¢æ€§å°±è¯»ä¸ä¸‹å»äº†ï¼Œåˆæµªè´¹äº†ä¸€æ¬¡æå‡è‡ªå·±çš„æœºä¼šğŸ˜­ã€‚
>
> <br/>
>
> æˆ‘è®¤ä¸º**æœ‰ä¸€ç§æ–¹æ³•**ï¼Œå¯ä»¥è§£å†³å¤§å®¶çš„å›°æ‰°ï¼**é‚£å°±æ˜¯é€šè¿‡é˜…è¯»æŸä¸€æ¬¡å¼€æºçš„ã€PRã€‘ï¼Œä»è¿™ä¸ªå…¥å£å‡ºå‘å»é˜…è¯»æºç ï¼ï¼**
>
> <br/>
>
> è‡³æ­¤ï¼Œæˆ‘ä»¬å‘ç°è‡ªå·±å¼€å§‹ä»å¤§é‡å †ç Œçš„æºç ä¸­è„±ç¦»å¼€æ¥ğŸ˜€ï¼ŒæŸ³æš—èŠ±æ˜åˆä¸€æ‘ã€‚

## ä¸€ã€å‰ç»

Okï¼Œå¼€å§‹æˆ‘ä»¬ä»Šå¤©çš„[PRé˜…è¯»](https://github.com/apache/shenyu/pull/4782)ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/direct/d42e82b540364164be4009489b6076e6.png#pic_center)

ç¿»è¯‘è¿‡æ¥å¤§è‡´æ„æ€å°±æ˜¯æ·»åŠ **æé†’é€šçŸ¥**çš„åŠŸèƒ½ã€‚ç¿»è¯‘å¦‚ä¸‹ï¼š

> **æ”¯æŒæé†’é€šçŸ¥è®¾è®¡**
>
> - Shenyu admin æä¾›è­¦æŠ¥æŠ¥å‘Š APIï¼Œ`/alert/report`ç”¨äºä»ç½‘å…³ pulgin æ¥æ”¶è­¦æŠ¥å†…å®¹
> - ç½‘å…³åœ¨è­¦æŠ¥è§¦å‘æ—¶å‘é€è­¦æŠ¥æ¶ˆæ¯
> - ç¥å®‡ä»ªè¡¨æ¿æ”¯æŒç®¡ç†è­¦æŠ¥æ¥æ”¶è€…åç§°ï¼Œè­¦æŠ¥ç±»å‹ï¼ˆç”µå­é‚®ä»¶ï¼Œé’‰é’‰ï¼Œå¾®ä¿¡...ï¼‰

æˆ‘ä»¬å¯ä»¥æ€è€ƒä¸‹ä»Šå¤©çš„**é˜…è¯»çº¿ç´¢äº†**ã€‚

1. ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘è¯¥è­¦æŠ¥ä¿¡æ¯
2. è¦æ”¯æŒå¤šç§è­¦æŠ¥ç±»å‹ï¼Œè´¡çŒ®è€…çš„ä»£ç æ˜¯**æ€ä¹ˆè®¾è®¡æˆå¯æ‰©å±•çš„**

## äºŒã€æ¢ç´¢

è¯ä¸å¤šè¯´ï¼Œå…ˆæ•´ä½“çœ‹ä¸‹æœ¬æ¬¡PRçš„æ•´ä½“æäº¤ï¼Œä»**å…¨å±€**çœ‹ä¸‹åšäº†å“ªäº›ä¿®æ”¹ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/direct/bc2988b0971241d198e5249d415f9e61.png#pic_center)

è¿˜æœ‰å¾ˆå¤šæäº¤æ²¡æœ‰æˆªå›¾ä¸‹æ¥ï¼Œæœ¬æ¬¡æäº¤ä»£ç é‡å¯è°“å·¨å¤§äº†ï¼Œé‚£æˆ‘ä»¬å°±å…ˆçœ‹çœ‹æœ€æ ¸å¿ƒçš„åŠŸèƒ½**shenyu-alertæ¨¡å—**ã€‚

å…ˆæ€è€ƒä¸‹ï¼Œæ—¢ç„¶æ˜¯å‘Šè­¦ï¼Œæ ¸å¿ƒæ¥å£å°±æ˜¯**å‘é€å‘Šè­¦æ¥å£**ï¼Œå¯ä»¥çœ‹åˆ°AlertNotifyHandlerçš„**sendæ¥å£**ï¼Œæˆ‘ä»¬å°±ä»è¿™ä¸ªå…¥å£å¼€å§‹æ¢ç´¢ï¼Œçœ‹çœ‹**çº¿ç´¢1**çš„ç­”æ¡ˆã€‚

```java
public interface AlertNotifyHandler {
    
    /**
     * send alert.
     *
     * @param receiver Notification configuration information
     * @param alert    Alarm information
     * @throws AlertNoticeException when send receiver error
     */
    void send(AlertReceiverDTO receiver, AlarmContent alert) throws AlertNoticeException;
    
    /**
     * alert type.
     *
     * @return type
     */
    byte type();
}
```

é€šè¿‡**å¼•ç”¨æ¥æŸ¥è¯¢**ï¼Œå‘ç°send()æ–¹æ³•æœ€ç»ˆçš„è°ƒç”¨è€…æ˜¯é€šè¿‡**Controller**æ¥è§¦å‘å‘Šè­¦ï¼Œå¾ˆå¥‡æ€ªï¼Œå‘Šè­¦ä¸æ˜¯åº”è¯¥å†…éƒ¨è§¦å‘å—ï¼Ÿ

```java
@RestApi("/alert/report")
public class AlertReportController {
    
    @Autowired
    private AlertDispatchService alertDispatchService;
    
    /**
     * report new alert content.
     *
     * @param alarmContent AlertContentDTO
     * @return row int
     */
    @PostMapping
    public ShenyuAdminResult reportAlert(@Valid @RequestBody final AlarmContent alarmContent) {
        alertDispatchService.dispatchAlert(alarmContent);
        return ShenyuAdminResult.success(ShenyuResultMessage.CREATE_SUCCESS);
    }
    
}
```

æˆ‘ä»¬é‡æ–°å›é¡¾ä¸‹è´¡çŒ®è€…åœ¨PR**å†™ä¸‹çš„æ³¨é‡Š**ï¼Œæœ‰æåˆ°ä¸‹é¢è¿™ä¸€æ¡ï¼š

> Shenyu admin æä¾›è­¦æŠ¥æŠ¥å‘Š APIï¼Œ`/alert/report`ç”¨äºä»ç½‘å…³ pulgin æ¥æ”¶è­¦æŠ¥å†…å®¹

ä¹Ÿå°±æ˜¯è¯´å‘Šè­¦æ˜¯é€šè¿‡**httpè¯·æ±‚**è§¦å‘ï¼ŒåŒæ—¶è§¦å‘å¯¹è±¡æ˜¯ç½‘å…³çš„å„ä¸ªpulginæ’ä»¶ã€‚

é‚£æˆ‘ä»¬å†çœ‹çœ‹**pulginæ’ä»¶ä»€ä¹ˆæƒ…å†µä¸‹**ä¼šå‘é€å‘Šè­¦çš„httpè¯·æ±‚å‘¢ã€‚

æˆ‘ä»¬ç›´æ¥é€šè¿‡å…¨å±€æœç´¢`/alert/report`ï¼Œçœ‹çœ‹å“ªäº›åœ°æ–¹è§¦å‘è¯¥httpè¯·æ±‚ã€‚

![å¾®ä¿¡æˆªå›¾_20240319165322](D:\code\z-mine\my_blog\2024.3.19\å¾®ä¿¡æˆªå›¾_20240319165322.png)

å†æ‰¾åˆ°å¯¹åº”æ‰§è¡Œçš„ä»£ç ï¼š

```java
public class GlobalErrorHandler implements ErrorWebExceptionHandler {

    private static final Logger LOG = LoggerFactory.getLogger(GlobalErrorHandler.class);

    /**
     * handler error.
     *
     * @param exchange  the exchange
     * @param throwable the throwable
     * @return error result
     */
    @Override
    @NonNull
    public Mono<Void> handle(@NonNull final ServerWebExchange exchange, @NonNull final Throwable throwable) {
        LOG.error("handle error: {} formatError:{} throwable:", exchange.getLogPrefix(), formatError(throwable, exchange.getRequest()), throwable);
        HttpStatus httpStatus;
        Object errorResult;
        String errorMsg = "";
        if (throwable instanceof IllegalArgumentException) {
            httpStatus = HttpStatus.BAD_REQUEST;
            errorResult = ShenyuResultWrap.error(exchange, httpStatus.value(), throwable.getMessage(), null);
            errorMsg = throwable.getMessage();
        } else if (throwable instanceof ResponseStatusException) {
            httpStatus = ((ResponseStatusException) throwable).getStatus();
            String errMsg = StringUtils.hasLength(((ResponseStatusException) throwable).getReason()) ? ((ResponseStatusException) throwable).getReason() : httpStatus.getReasonPhrase();
            errorResult = ShenyuResultWrap.error(exchange, httpStatus.value(), errMsg, null);
            errorMsg = errMsg;
        } else {
            httpStatus = HttpStatus.INTERNAL_SERVER_ERROR;
            errorResult = ShenyuResultWrap.error(exchange, httpStatus.value(), httpStatus.getReasonPhrase(), null);
            errorMsg = httpStatus.getReasonPhrase();
        }
        exchange.getResponse().setStatusCode(httpStatus);
        Map<String, String> labels = new HashMap<>(8);
        labels.put("global", "error");
        labels.put("component", "gateway");
        AlarmSender.alarmMediumCritical("ShenYu-Gateway-Global-Error", errorMsg, labels);
        return WebFluxResultUtils.result(exchange, errorResult);
    }

}
```

å¯ä»¥çœ‹åˆ°è°ƒç”¨è€…å®ç°äº†**Springçš„ErrorWebExceptionHandler**ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè­¦æŠ¥çš„å®é™…è°ƒç”¨è€…æ˜¯ç”¨Springå†…ç½®çš„**webé”™è¯¯å¤„ç†å™¨**ã€‚

åˆ°è¿™é‡Œæˆ‘ä»¬å°±è§£å†³äº†æˆ‘ä»¬çš„**é˜…è¯»çº¿ç´¢1**äº†ã€‚

> ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘è¯¥è­¦æŠ¥ä¿¡æ¯

è¿˜æ²¡å®Œå‘¢ï¼Œæˆ‘ä»¬ç»§ç»­é˜…è¯»çº¿ç´¢2çš„æ¢ç´¢ï¼šè¦æ”¯æŒå¤šç§è­¦æŠ¥ç±»å‹ï¼Œè´¡çŒ®è€…çš„ä»£ç æ˜¯**æ€ä¹ˆè®¾è®¡æˆå¯æ‰©å±•çš„**ã€‚

æ—¢ç„¶è¦å¯æ‰©å±•ï¼Œè‚¯å®šæœ‰**åº•å±‚æ¥å£**åœ¨è®¾å®šè§„åˆ™ï¼Œæˆ‘ä»¬æ‰¾ä¸‹è¿™ä¸ªåº•å±‚æ¥å£ã€‚

![å¾®ä¿¡æˆªå›¾_20240319170134](D:\code\z-mine\my_blog\2024.3.19\å¾®ä¿¡æˆªå›¾_20240319170134.png)

è¿™ä¸ªåº•å±‚æ¥å£å…¶å®è¿˜æ˜¯æˆ‘ä»¬ä¸Šæ–‡æåˆ°çš„**sendæ¥å£**ï¼Œå¯ä»¥çœ‹åˆ°sendæ–¹æ³•çš„**å­ç±»å®ç°**æœ‰é’‰é’‰ã€é‚®ç®±é€šçŸ¥ã€‚

ä¸¤ä¸ªå­ç±»å®ç°éƒ½æ˜¯å®ç°ç›¸åŒçš„**åº•å±‚æ¥å£AlertNotifyHandler**ï¼Œåªè¦åœ¨é…ç½®ä¸Šé…ç½®å“ªä¸ªé€šçŸ¥å®ç°ï¼ŒShenYu alertæ¨¡å—ä¾¿ä¼šå®ä¾‹åŒ–å¯¹åº”çš„é€šçŸ¥å®ç°ï¼Œä¹Ÿå°±èƒ½è¾¾åˆ°**å¯æ‰©å±•**çš„ç›®çš„ã€‚

```java
@Component
final class EmailAlertNotifyStrategy implements AlertNotifyHandler { }
```

```java
@Component
final class EmailAlertNotifyStrategy implements AlertNotifyHandler { }
```

## ä¸‰ã€æ€»ç»“

åœ¨é˜…è¯»ä¸­ï¼Œè¿˜å‘ç°äº†æœ‰ä¸ªhtmlæ–‡ä»¶å¿˜è®°åŠ äº†å¼€æºåè®®ï¼Œæˆ‘ä»¬æä¸‹**PRä¿®å¤ä¸‹**ï¼Œåˆæ”¶è·äº†ä¸€æ¬¡å¼€æºè´¡çŒ®ï¼ï¼

[PRæäº¤](https://github.com/apache/shenyu/pull/5503)æˆ³è¿™ã€‚

![å¾®ä¿¡æˆªå›¾_20240319173138](D:\code\z-mine\my_blog\2024.3.19\å¾®ä¿¡æˆªå›¾_20240319173138.png)

## æœªå®Œå¾…ç»­ã€‚ã€‚ã€‚

å¥½äº†ï¼Œä»Šå¤©çš„åˆ†äº«å°±åˆ°è¿™ğŸ¤”ã€‚**å¤§å®¶èƒ½å¦æ„Ÿå—åˆ°é€šè¿‡PRè¿™ç§æ–¹å¼æ¥é˜…è¯»æºç çš„ä¹è¶£å‘¢** ï¼

> **åˆ›ä½œä¸æ˜“ï¼Œä¸å¦¨ç‚¹èµã€æ”¶è—ã€å…³æ³¨æ”¯æŒä¸€ä¸‹ï¼Œå„ä½çš„æ”¯æŒå°±æ˜¯æˆ‘åˆ›ä½œçš„æœ€å¤§åŠ¨åŠ›**â¤ï¸