# è¶…è¶Šæºç é˜…è¯»ä¹‹shenyuç½‘å…³-å“åº”å‚æ•°æ’ä»¶

> æˆ‘ä»¬å¤§å®¶ç»å¤§æ•°äººç¢°åˆ°æºç ä¸€å¼€å§‹éƒ½æ˜¯æ¯”è¾ƒæ— ä»ä¸‹æ‰‹çš„ï¼Œä¸çŸ¥é“ä»å“ªå¼€å§‹é˜…è¯»ã€é˜…è¯»äº†æœ‰ä»€ä¹ˆç”¨ã€‚æˆ‘è®¤ä¸ºæœ‰ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œè®©æˆ‘ä»¬æ—¢çŸ¥é“äº†ä»å“ªå¼€å§‹é˜…è¯»æºç ï¼Œåˆèƒ½å¤Ÿä»é˜…è¯»æºç ä¸­è·å¾—æ”¶è·ã€‚
>
> 
>
> é‚£å°±æ˜¯é€šè¿‡é˜…è¯»æŸä¸€æ¬¡**å¼€æºcommit**ã€æŸä¸€æ¬¡**ISSUEçš„æå‡º**ï¼Œä»è¿™ä¸ªå…¥å£å‡ºå‘ï¼Œå»æ¢ç´¢æºç ã€‚
>
> 
>
> é€šè¿‡ä¸Šé¢çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä»å †ç Œçš„æºç ä¸­è„±ç¦»å¼€æ¥ï¼Œå»é˜…è¯»å…¶ä¸­è®©æˆ‘ä»¬æ›´æœ‰å…´è¶£çš„éƒ¨åˆ†ï¼Œéƒ½è¯´å…´è¶£æ˜¯æœ€å¥½çš„è€å¸ˆï¼Œå…´è¶£è€å¸ˆä¼šå¼•å¯¼æˆ‘ä»¬èµ°å‘æ­£ç¡®çš„é“è·¯ï¼Œè®©æˆ‘ä»¬è·å–æˆ‘ä»¬éœ€è¦çš„æ”¶è·ï¼Œæœ€åç”šè‡³è¿˜ä¼šé€ç»™ä½ ä¸€æœµå°çº¢èŠ±å½“ä½œå¥–åŠ±å˜»å˜»ğŸ¤­ã€‚

## å‰ç»

é‚£å°±è®©æˆ‘ä»¬ä»è¿™æ¬¡å¼€æºæäº¤å¼€å§‹ï¼šhttps://github.com/apache/shenyu/issues/1292

![Snipaste_2024-02-20_21-42-44](D:\Users\win\Desktop\blog\2024.2.20\Snipaste_2024-02-20_21-42-44.png)

ä»è¿™æ¬¡**ISSUE**å¯ä»¥çŸ¥é“ï¼Œæœ¬æ¬¡å¼€æºcommitæ˜¯å¢åŠ ä¸€ä¸ª**æ¥å£å“åº”ç çš„æ’ä»¶**ã€‚

## æ¢ç´¢

é€šè¿‡å¯¹æ‰€æœ‰æäº¤çš„æŸ¥çœ‹ï¼ŒæŠŠæ ¸å¿ƒç±»é”å®šåœ¨**ModifyResponsePlugin**ï¼Œä»¥ä¸‹å°±æ ¸å¿ƒç±»å¼€å§‹å¯¹æœ¬æ¬¡commitè¿›è¡Œæ¢ç´¢ã€‚

![Snipaste_2024-02-20_21-48-06](D:\Users\win\Desktop\blog\2024.2.20\Snipaste_2024-02-20_21-48-06.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ ¸å¿ƒæ–¹æ³•**doExecute**æŠŠshenyuå¯¹å“åº”æ’ä»¶çš„**è‡ªå®šä¹‰è§„åˆ™Rule**ï¼Œä¼ å…¥åˆ°Springæ¡†æ¶è‡ªå¸¦çš„**ServerWebExchange**è¿›è¡Œä¿®æ”¹ï¼Œå…¥å‚`new ModifyResponseDecorator(exchange, ruleHandle)).build()`ä¹Ÿå°±æ˜¯æäº¤è€…å¯¹å“åº”å‚æ•°çš„æ‰€ä½œå‡ºçš„ä¿®æ”¹ã€‚

![Snipaste_2024-02-20_22-06-46](D:\Users\win\Desktop\blog\2024.2.20\Snipaste_2024-02-20_22-06-46.png)

ModifyResponseDecoratorç±»å¦‚ä¸‹ï¼Œ**buildModifiedResponse**æ–¹æ³•å°±æ˜¯å…³é”®ï¼Œä¿®æ”¹çš„ä»£ç æ²¡ä»€ä¹ˆå¥½è¯´çš„å¯ä»¥è‡ªå·±çœ‹çœ‹ã€‚

```java
static class ModifyResponseDecorator extends ServerHttpResponseDecorator {

        private final ServerWebExchange exchange;

        private final ModifyResponseRuleHandle ruleHandle;

        ModifyResponseDecorator(final ServerWebExchange exchange,
                                final ModifyResponseRuleHandle ruleHandle) {
            super(exchange.getResponse());
            this.exchange = exchange;
            this.ruleHandle = ruleHandle;
        }

        @Override
        @NonNull
        public Mono<Void> writeWith(@NonNull final Publisher<? extends DataBuffer> body) {
            final Mono<DataBuffer> dataBufferMono = DataBufferUtils.join(body);
            buildModifiedResponse(body);
            return dataBufferMono.flatMap(dataBuffer -> {
                byte[] bytes = new byte[dataBuffer.readableByteCount()];
                dataBuffer.read(bytes);
                return WebFluxResultUtils.result(this.exchange, modifyBody(bytes));
            });
        }

        private void buildModifiedResponse(final Publisher<? extends DataBuffer> body) {
            HttpHeaders httpHeaders = new HttpHeaders();
            // add origin headers
            httpHeaders.addAll(this.getHeaders());

            // add new headers
            if (MapUtils.isNotEmpty(this.ruleHandle.getAddHeaders())) {
                Map<String, String> addHeaderMap = this.ruleHandle.getAddHeaders();
                addHeaderMap.forEach(httpHeaders::add);
            }

            // set new headers
            if (MapUtils.isNotEmpty(this.ruleHandle.getSetHeaders())) {
                Map<String, String> setHeaderMap = this.ruleHandle.getSetHeaders();
                setHeaderMap.forEach(httpHeaders::set);
            }

            // replace headers
            if (MapUtils.isNotEmpty(this.ruleHandle.getReplaceHeaderKeys())) {
                Map<String, String> replaceHeaderMap = this.ruleHandle.getReplaceHeaderKeys();
                replaceHeaderMap.forEach((key, value) -> httpHeaders.replace(key, Collections.singletonList(value)));
            }

            // remove headers
            if (CollectionUtils.isNotEmpty(this.ruleHandle.getRemoveHeaderKeys())) {
                Set<String> removeHeaderList = this.ruleHandle.getRemoveHeaderKeys();
                removeHeaderList.forEach(httpHeaders::remove);
            }

            // reset http status
            if (this.ruleHandle.getStatusCode() > 0) {
                this.setStatusCode(HttpStatus.valueOf(this.ruleHandle.getStatusCode()));
            }

            // reset http headers
            this.getDelegate().getHeaders().clear();
            this.getDelegate().getHeaders().putAll(httpHeaders);
        }

        private byte[] modifyBody(final byte[] responseBody) {
            try {
                String bodyStr = modifyBody(new String(responseBody, StandardCharsets.UTF_8));
                LOG.info("the body string {}", bodyStr);
                return bodyStr.getBytes(StandardCharsets.UTF_8);
            } catch (Exception e) {
                LOG.error("modify response error", e);
                throw new ShenyuException(String.format("response modify failure. %s", e.getLocalizedMessage()));
            }
        }

        private String modifyBody(final String jsonValue) {
            DocumentContext context = JsonPath.parse(jsonValue);
            if (CollectionUtils.isNotEmpty(this.ruleHandle.getAddBodyKeys())) {
                this.ruleHandle.getAddBodyKeys().forEach(info -> context.put(info.getPath(), info.getKey(), info.getValue()));
            }
            if (CollectionUtils.isNotEmpty(this.ruleHandle.getReplaceBodyKeys())) {
                this.ruleHandle.getReplaceBodyKeys().forEach(info -> context.renameKey(info.getPath(), info.getKey(), info.getValue()));
            }
            if (CollectionUtils.isNotEmpty(this.ruleHandle.getRemoveBodyKeys())) {
                this.ruleHandle.getRemoveBodyKeys().forEach(context::delete);
            }
            return context.jsonString();
        }
    }
```

## æ€»ç»“

ä»”ç»†ä¸€çœ‹**buildModifiedResponse**æ–¹æ³•çš„å…¥å‚bodyçš„æ²¡æœ‰ä½¿ç”¨åˆ°ï¼Œä¸”è¯¥æ–¹æ³•çš„å‘½åä¹Ÿæœ‰ä¸å¦¥ï¼ŒmodifyResponseHeadersAndStatusè¿™ä¸ªå‘½åæ›´æ˜“ç†è§£ä¹Ÿæ›´ç¬¦åˆä»£ç ä¿®æ”¹ã€‚èµ¶ç´§æä¸€æ¬¡commitå“ˆå“ˆã€‚https://github.com/apache/shenyu/pull/5397/commits/5a96dcf5726a689f52263004f92c769a478ee831

![Snipaste_2024-02-20_22-17-44](D:\Users\win\Desktop\blog\2024.2.20\Snipaste_2024-02-20_22-17-44.png)

åˆæ”¶è·äº†ä¸€æ¬¡å¼€æºæäº¤ï¼ï¼ï¼

**èƒ½å¦æ„Ÿå—é€šè¿‡commitã€ISSUEè¿™ç§æ–¹å¼æ¥é˜…è¯»æºç çš„ä¹è¶£å‘¢ï¼Œå­¦ä¹ äº†çŸ¥è¯†ã€è·å¾—äº†å¼€æºcommitï¼Œä½•ä¹è€Œä¸ä¸ºå‘¢**

å¯¹ä½œè€…æ„Ÿå…´è¶£çš„è¯ï¼Œä¸å¦¨å…³æ³¨ã€ç‚¹èµã€æ”¶è—æ”¯æŒä¸€ä¸‹å˜ï¼ğŸ˜˜